<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"> 
<head>
<title>List Table Control</title>

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:TemplateHidden msdt:dt="string">0</mso:TemplateHidden>
<mso:MasterPageDescription msdt:dt="string">This is the table layout control template.</mso:MasterPageDescription>
<mso:ContentTypeId msdt:dt="string">0x0101002039C03B61C64EC4A04F5361F385106601</mso:ContentTypeId>
<mso:TargetControlType msdt:dt="string">;#Content Web Parts;#</mso:TargetControlType>
<mso:HtmlDesignAssociated msdt:dt="string">1</mso:HtmlDesignAssociated>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>
    <script>
        estruyf = window.estruyf || {};
        estruyf.Table = estruyf.Table || {};

        /*********************************
         * Show property sorting options *
         *********************************/
        estruyf.Table.Layout = function() {
            var tableContext = {};
            return {
                setContext: function (context, cc, tableId) {
                    tableContext[tableId] = {};
                    estruyf.Table.Layout.setCurrentCtx(context, tableId);
                    estruyf.Table.Layout.setClientControl(cc, tableId);
                    estruyf.Table.Layout.setProperties(cc, tableId);
                },
                setCurrentCtx: function (context, tableId) {
                    tableContext[tableId]["currentCtx"] = context;
                },
                setClientControl: function (cc, tableId) {
                    tableContext[tableId]["clientControl"] = cc;
                },
                setProperties: function (cc, tableId) {
                    if (!Srch.U.n(cc)) {
                        var propertyMappings = cc.get_propertyMappings();
                        if (!Srch.U.n(propertyMappings) && !Srch.U.w(propertyMappings)) {
                            tableContext[tableId]["properties"] = Srch.Result.parsePropertyMappingsString(propertyMappings);
                        }
                    }
                },
                // Add the sortable properties to your search context
                addSortableProperty: function (property, tableId) {
                    var availableSorts = tableContext[tableId].currentCtx.DataProvider.get_availableSorts();
                    availableSorts.push({ "name": property + "ASC", "sorts": [{ "p": property, "d": 0 }] });
                    availableSorts.push({ "name": property + "DES", "sorts": [{ "p": property, "d": 1 }] });
                    tableContext[tableId].currentCtx.DataProvider.set_availableSorts(availableSorts);
                },
                // Keep a list of all the unsortable properties
                addUnsortableProperty: function (property, tableId) {
                    if (typeof tableContext[tableId].currentCtx.DataProvider.Unsortable === "undefined") {
                        // Create an empty unsortable array
                        tableContext[tableId].currentCtx.DataProvider.Unsortable = [];
                    }
                    tableContext[tableId].currentCtx.DataProvider.Unsortable.push(property);
                },
                // Check if a property is sortable
                checkSortableProperty: function (property, tableId) {
                    var availableSorts = tableContext[tableId].currentCtx.DataProvider.get_availableSorts();
                    var indexArray = availableSorts.map(function(o){return o.name;});
                    var currentPropIdx = indexArray.indexOf(property+"ASC");
                    return currentPropIdx === -1 ? true : false;
                },
                // Check if a property is not sortable
                checkUnsortableProperty: function (property, tableId) {
                    if (typeof tableContext[tableId].currentCtx.DataProvider.Unsortable !== "undefined") {
                        var unsortableProps = tableContext[tableId].currentCtx.DataProvider.Unsortable;
                        return unsortableProps.indexOf(property) === -1 ? true : false;
                    } else {
                        return true;
                    }
                },
                // Hide the property options which are not sortable
                hideSortableOptions: function (property, tableId) {
                    var elm = document.querySelector('#' + tableId + ' #' + property.replace(/ /g, '-'));
                    if (elm !== null) {
                        elm.style.display = 'none';
                    }
                },
                // Highlight the properties that are currently sorted
                setCurrentSorting: function (tableId) {
                    var queryState = tableContext[tableId].currentCtx.DataProvider.get_currentQueryState().o;
                    if (queryState !== null && queryState.length > 0) {
                        for (var i = 0; i < queryState.length; i++) {
                            var sortName = queryState[i].p;
                            var sortDir = queryState[i].d;
                            if (!Srch.U.e(sortName)) {
                                var elm = document.querySelector('#' + tableId + ' #' + sortName.replace(/ /g, '-'));
                                if (elm !== null) {
                                    elm.parentNode.style.fontWeight = "bold";
                                    var sortElm = elm.getElementsByClassName('sortarrow')[0];
                                    if (sortElm !== null) {
                                        if (sortDir === 0){
                                            sortElm.innerHTML = "<img src='/_layouts/15/images/spcommon.png' class='ms-sortarrowup-icon'>";
                                        } else {
                                            sortElm.innerHTML = "<img src='/_layouts/15/images/spcommon.png' class='ms-sortarrowdown-icon'>";
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                // Show the property sorting options
                showPropertySorting: function (tableId) {
                    // Check if the properties array is empty. 
                    // This can happen if you do not override the managed properties in the web part.
                    if ($isEmptyArray(tableContext[tableId].properties)) {
                        if (!Srch.U.n(DisplayTemplateData)) {
                            if (!Srch.U.n(DisplayTemplateData.ManagedPropertyMapping)) {
                                tableContext[tableId].properties = DisplayTemplateData.ManagedPropertyMapping;
                            }
                        }
                    }
                    
                    if (!$isEmptyArray(tableContext[tableId].properties)) {
                        for (var key in tableContext[tableId].properties) {
                            if (!Srch.U.e(tableContext[tableId].properties[key])) {
                                var prop = tableContext[tableId].properties[key].toString();
                                if (estruyf.Table.Layout.checkSortableProperty(prop, tableId)) {
                                    if (estruyf.Table.Layout.checkUnsortableProperty(prop, tableId)) {
                                        (function (prop, tableId) {
                                            // Do a Ajax call for each property to check if it is sortable
                                            var request = new XMLHttpRequest();
                                            var restUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/search/query?querytext='*'&sortlist='" + tableContext[tableId].properties[key] +":ascending'&RowLimit=1&selectproperties='Path'";
                                            request.open('GET', restUrl, true);
                                            request.onload = function (e) {
                                                if (request.readyState === 4) {
                                                    // Check if the get was successful
                                                    if (request.status === 200) {
                                                        estruyf.Table.Layout.addSortableProperty(prop, tableId);
                                                    } else {
                                                        estruyf.Table.Layout.addUnsortableProperty(prop, tableId);
                                                        // Hide the sorting options
                                                        estruyf.Table.Layout.hideSortableOptions(prop, tableId);
                                                    }
                                                }
                                            };
                                            request.onerror = function (e) {
                                                // Catching errors
                                            };
                                            request.send(null);
                                        })(prop, tableId);
                                    } else {
                                        // Hide the sorting options
                                        estruyf.Table.Layout.hideSortableOptions(prop, tableId);
                                    }
                                }
                            }
                        }
                    }
                }
            };
        }();


        /******************************************
         * Sorting functions / Multi sort enabled *
         ******************************************/
        estruyf.Table.Sort = function () {
            return {
                sortProperty: function (sortName, clientControl) {
                    if (Srch.U.e(sortName)) {
                        return;
                    }
                    var dataProvider = clientControl.get_dataProvider();
                    if (Srch.U.n(dataProvider)) {
                        return;
                    }

                    // Retrieve the available sorts
                    var availableSorts = dataProvider.get_availableSorts();
                    // Retrieve the current sorts
                    var currentSorts = clientControl.get_dataProvider().get_currentQueryState().o;

                    if (!Srch.U.n(availableSorts) && availableSorts.length > 0) {
                        var clickedSort;
                        // Loop over each of the available sortings
                        for (var i = 0; i < availableSorts.length; i++) {
                            var sort = availableSorts[i];
                            // Check if the sorting has been selected
                            if (!Srch.U.n(sort) && sort.name === sortName) {
                                // Store the current sorting
                                clickedSort = sort.sorts;
                            }
                        }

                        var sortarray = [];
                        var processed = false;
                        // Check if there was already sorting in place
                        if (!Srch.U.n(currentSorts) && currentSorts.length > 0) {
                            // Loop over the current sorts
                            for (var i = 0; i < currentSorts.length; i++) {
                                var currentSort = currentSorts[i];
                                // Check if the current sort is equal to the clicked sort
                                if (currentSort.p === clickedSort[0].p) {
                                    // Push the new sorting option on the array
                                    sortarray.push(clickedSort[0]);
                                    processed = true;
                                } else {
                                    // Push the unchanged sort on the array
                                    var sortObj = { p: currentSort.p, d: currentSort.d };
                                    sortarray.push(sortObj);
                                }
                            }
                            // Check if the clicked sorting was processed.
                            // If it is not processed, push it on the array.
                            if (!processed) {
                                sortarray.push(clickedSort[0]);
                            }
                        } else {
                            // If the results were not yet sorted, use the clicked sort option
                            sortarray = clickedSort;
                        }

                        // Do a new query with the sort information
                        var queryState = new Srch.QueryState();
                        queryState.o = sortarray;
                        queryState.s = 1;
                        var queryEvent = new Srch.QueryEventArgs(queryState);
                        queryEvent.userAction = 4;
                        clientControl.raiseQueryReadyEvent(queryEvent);
                        return;
                    }
                },
                removeSortProperty: function (property, clientControl) {
                    if (Srch.U.e(property)) {
                        return;
                    }
                    var dataProvider = clientControl.get_dataProvider();
                    if (Srch.U.n(dataProvider)) {
                        return;
                    }

                    // Retrieve the current sorts
                    var currentSorts = clientControl.get_dataProvider().get_currentQueryState().o;

                    // Check if the results are already sorted, otherwise the property cannot be removed
                    if (!Srch.U.n(currentSorts) && currentSorts.length > 0) {
                        var sortarray = [];
                        var processed = false;
                        // Loop over the current sorts
                        for (var i = 0; i < currentSorts.length; i++) {
                            var currentSort = currentSorts[i];
                            // Check if the current sort is equal to the clicked sort
                            if (currentSort.p !== property) {
                                // Push the unchanged sort on the array
                                var sortObj = { p: currentSort.p, d: currentSort.d };
                                sortarray.push(sortObj);
                            } else {
                                processed = true;
                            }
                        }

                        // Check if the sort option was removed from the sorting array
                        if (processed) {
                            // Do a new query with the sort information
                            var queryState = new Srch.QueryState();
                            queryState.o = sortarray;
                            queryState.s = 1;
                            var queryEvent = new Srch.QueryEventArgs(queryState);
                            queryEvent.userAction = 4;
                            clientControl.raiseQueryReadyEvent(queryEvent);
                            return;
                        }
                    }
                }
            };
        }();


        /************************************************
         * Callout functions to view or edit properties *
         ************************************************/
        estruyf.Table.Callout = function () {
            return {
                setCallouts: function (tableId) {
                    SP.SOD.executeFunc("callout.js", "Callout", function () {
                        var tableElement = document.getElementById(tableId);
                        var targetElement = tableElement.getElementsByClassName('NotificationDiv');
                        if (targetElement.length > 0) {
                            for (var i = 0; i < targetElement.length; i++) {
                                var elm = targetElement[i];
                                var calloutOptions = new CalloutOptions();
                                calloutOptions.ID = 'notificationcallout-' + i;
                                calloutOptions.launchPoint = elm;
                                calloutOptions.beakOrientation = 'leftRight';
                                calloutOptions.content = String.format('<a href="{0}&PageType=4" onclick="estruyf.Table.Callout.redirectToPropertiesUrl(this, \'{1}\');return false;" title="View properties">View properties</a><br /><a href="{0}&PageType=6" onclick="estruyf.Table.Callout.redirectToPropertiesUrl(this, \'{1}\');return false;" title="Edit properties">Edit properties</a>', elm.getAttribute('rel'), elm.getAttribute('path'));
                                calloutOptions.title = elm.getAttribute('ref');

                                var displayedPopup = CalloutManager.createNew(calloutOptions);
                            }
                        }
                    });
                },
                redirectToPropertiesUrl: function (element, docPath) {
                    docPath = docPath.substring(0, docPath.lastIndexOf('/')) + "/_api/contextinfo";
                    var request = new XMLHttpRequest();
                    request.open('POST', docPath, true);
                    request.setRequestHeader('Accept', 'application/json; odata=verbose');
                    request.onload = function (e) {
                        if (request.readyState === 4) {
                            if (!Srch.U.n(request.response)) {
                                var data = JSON.parse(request.response);
                                var webUrl = data.d.GetContextWebInformation.WebFullUrl;
                                // Check if the web url that is retrieved is not null or empty
                                if (!Srch.U.n(webUrl) && !Srch.U.e(webUrl)) {
                                    GoToPage(String.format('{0}{1}', webUrl, element.getAttribute('href')));
                                }
                            }
                        }
                    };
                    request.onerror = function (e) {
                        // Catching errors
                    };
                    request.send(null);
                    return false;
                }
            };
        }();
    </script>

    <div id="Control_Table">
<!--#_ 
var tableId = ctx.ClientControl.get_nextUniqueId() + "_table";

if (!$isNull(ctx.ClientControl) && !$isNull(ctx.ClientControl.shouldRenderControl) && !ctx.ClientControl.shouldRenderControl()) {
    return "";
}

// Get the client control
var clientControl = ctx.ClientControl;

// Set the current context
estruyf.Table.Layout.setContext(ctx, clientControl, tableId);

AddPostRenderCallback(ctx, function() {
    // Show the current sort option
    estruyf.Table.Layout.showPropertySorting(tableId);

    // Show or hide the sort options
    estruyf.Table.Layout.setCurrentSorting(tableId);

    // Add a callout to each row
    estruyf.Table.Callout.setCallouts(tableId);
});

ctx.ClientControl.set_showSortOptions(true);

ctx.ListDataJSONGroupsKey = "ResultTables";

var ListRenderRenderWrapper = function(itemRenderResult, inCtx, tpl)
{
    var iStr = [];
    iStr.push(itemRenderResult);
    return iStr.join('');
}
ctx['ItemRenderWrapper'] = ListRenderRenderWrapper;
_#-->
        <table id="_#= tableId =#_" class="cbs-List">
            _#= ctx.RenderGroups(ctx) =#_
        </table>

<!--#_
    var showPaging = ctx.ClientControl.get_showPaging();
    if(showPaging)
    {
        var pagingInfo = ctx.ClientControl.get_pagingInfo();
        showPaging = !$isEmptyArray(pagingInfo);
        if(showPaging)
        {
            var currentPage = null;
            var firstPage = pagingInfo[0];
            var lastPage = pagingInfo[pagingInfo.length - 1];

            for (var i = 0; i< pagingInfo.length; i++)
            {
                var pl = pagingInfo[i];
                if (!$isNull(pl))
                {
                    if (pl.startItem == -1)
                    {
                        currentPage = pl;
                    }
                }
            }

            var getPagingImageClassName = function(buttonClassNamePrefix, isNext, isEnabled)
            {
                var className = buttonClassNamePrefix;
                className += (isNext && !Srch.U.isRTL()) || (!isNext && Srch.U.isRTL()) ? "right" : "left";
                if(!$isNull(isEnabled) && isEnabled == false)
                {
                    className += "-disabled";
                }
                return className;
            }

            var getPagingContainerClassName = function(buttonClassNamePrefix, isEnabled)
            {
                var className = buttonClassNamePrefix;
                className += isEnabled ? "enabled" : "disabled";
                return className;
            }

            var hasNextPage = lastPage.pageNumber == -2;
            var hasPreviousPage = firstPage.pageNumber == -1;
            var buttonClassNamePrefix = "ms-promlink-button-";
            var nextPageContainerClassName = getPagingContainerClassName(buttonClassNamePrefix, hasNextPage);
            var previousPageContainerClassName = getPagingContainerClassName(buttonClassNamePrefix, hasPreviousPage);
            var nextPageImageClassName = getPagingImageClassName(buttonClassNamePrefix, true, hasNextPage);
            var previousPageImageClassName = getPagingImageClassName(buttonClassNamePrefix, false, hasPreviousPage);
    _#-->
        <div class="ms-promlink-header">
            <span class="ms-promlink-headerNav">
                <a class="ms-commandLink ms-promlink-button _#= $htmlEncode(previousPageContainerClassName) =#_" title="_#= $htmlEncode(firstPage.title) =#_" href="#" onclick='$getClientControl(this).page(_#= $htmlEncode(firstPage.startItem) =#_);return Srch.U.cancelEvent(event);'>
                    <span class="ms-promlink-button-image">
                        <img class="_#= $htmlEncode(previousPageImageClassName) =#_" alt="_#= $htmlEncode(firstPage.title) =#_" src="_#= $urlHtmlEncode(GetThemedImageUrl('spcommon.png')) =#_">
                    </span>
                </a>
                <span class="ms-promlink-button-inner"></span>
                <a class="ms-commandLink ms-promlink-button _#= $htmlEncode(nextPageContainerClassName) =#_" title="_#= $htmlEncode(lastPage.title) =#_" href="#" onclick='$getClientControl(this).page(_#= $htmlEncode(lastPage.startItem) =#_);return Srch.U.cancelEvent(event);'>
                    <span class="ms-promlink-button-image">
                        <img class="_#= $htmlEncode(nextPageImageClassName) =#_" alt="_#= $htmlEncode(lastPage.title) =#_" src="_#= $urlHtmlEncode(GetThemedImageUrl('spcommon.png')) =#_">
                    </span>
                </a>
            </span>
        </div>
        <!--#_
        }
    }
    _#-->

    </div>
</body>
</html>
